<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Baiter</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #64748b;
            --accent: #f59e0b;
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 14px;
            position: relative;
        }

        .auth-section {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .login-btn, .logout-btn {
            padding: 12px 20px;
            border: 1px solid var(--primary);
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            background: var(--primary);
            color: white;
            margin: 0;
        }

        .login-btn:focus, .logout-btn:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .login-btn.hidden {
            display: none !important;
        }

        .login-btn:hover, .logout-btn:hover {
            opacity: 0.9;
        }

        .logout-btn {
            background: var(--danger);
            border-color: var(--danger);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 60px 20px 40px;
        }

        .hero-section {
            text-align: center;
            padding: 80px 0 60px;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: -2px;
        }

        .generate-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 50px;
            text-align: center;
        }

        .generate-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
        }

        .generate-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .generate-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(220, 38, 38, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loader {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 50px;
        }

        .results-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 40px;
            color: var(--primary);
            text-transform: uppercase;
        }

        .results-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .roast-number {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .roast-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--text);
            background: var(--bg);
            padding: 24px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-weight: 600;
        }

        .copy-btn {
            width: 100%;
            padding: 14px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            text-transform: uppercase;
        }

        .copy-btn:hover {
            background: #475569;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text);
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: all 0.3s ease;
            font-weight: 500;
            opacity: 0;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .toast.error {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 40px 16px 20px;
            }
            
            .auth-section {
                top: 16px;
                right: 16px;
            }
            
            .hero-title {
                font-size: 2.8rem;
            }
            
            .generate-section {
                padding: 30px 20px;
            }
            
            .generate-btn {
                padding: 16px 30px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 2.2rem;
            }
            
            .generate-section {
                padding: 24px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-section">
        <button id="loginBtn" class="login-btn">Connect</button>
        <div id="userInfo" class="user-info hidden">
            <div class="status-dot"></div>
            <span id="userName"></span>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
    </div>

    <div class="container">
        <section class="hero-section">
            <h1 class="hero-title">Ragebait 'em</h1>
        </section>

        <section class="generate-section">
            <h2 class="generate-title">Ragebait 'em</h2>
            <p class="generate-subtitle">Imagine being so unemployed you gotta use ts ðŸ¥€</p>
            
            <button id="generateBtn" class="generate-btn" disabled>
                <span class="btn-text">bait 'em all</span>
                <div class="btn-loader hidden"></div>
            </button>
        </section>

        <section class="results-section">
            <div id="resultsContainer" class="results-container hidden">
                <h2 class="results-title">Here you go gng</h2>
                <div class="results-grid" id="resultsGrid"></div>
            </div>
        </section>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Completely rewritten JavaScript with proper error handling
        (function() {
            'use strict';
            
            // Application state
            let appState = {
                isAuthenticated: false,
                currentUser: null,
                generationCount: 0,
                isGenerating: false
            };
            
            // DOM elements - cached for performance
            const elements = {
                loginBtn: null,
                logoutBtn: null,
                userInfo: null,
                userName: null,
                generateBtn: null,
                btnText: null,
                btnLoader: null,
                resultsContainer: null,
                resultsGrid: null,
                toast: null
            };
            
            // Initialize DOM elements
            function initElements() {
                elements.loginBtn = document.getElementById('loginBtn');
                elements.logoutBtn = document.getElementById('logoutBtn');
                elements.userInfo = document.getElementById('userInfo');
                elements.userName = document.getElementById('userName');
                elements.generateBtn = document.getElementById('generateBtn');
                elements.btnText = document.querySelector('.btn-text');
                elements.btnLoader = document.querySelector('.btn-loader');
                elements.resultsContainer = document.getElementById('resultsContainer');
                elements.resultsGrid = document.getElementById('resultsGrid');
                elements.toast = document.getElementById('toast');
                
                // Verify all elements exist
                for (const [key, element] of Object.entries(elements)) {
                    if (!element) {
                        console.error(`Element not found: ${key}`);
                    }
                }
            }
            
            // Toast notification system
            function showToast(message, type = 'info') {
                if (!elements.toast) return;
                
                // Clear any existing toast
                elements.toast.classList.remove('show', 'success', 'error');
                elements.toast.style.opacity = '0';
                
                setTimeout(() => {
                    elements.toast.textContent = message;
                    elements.toast.classList.add('show', type);
                    elements.toast.style.opacity = '1';
                    
                    // Auto-hide after 4 seconds
                    setTimeout(() => {
                        elements.toast.classList.remove('show');
                        elements.toast.style.opacity = '0';
                    }, 4000);
                }, 100);
            }
            
            // Update UI based on authentication state
            function updateAuthUI() {
                if (appState.isAuthenticated && appState.currentUser) {
                    elements.loginBtn.classList.add('hidden');
                    elements.userInfo.classList.remove('hidden');
                    elements.userName.textContent = appState.currentUser.username || 'User';
                    elements.generateBtn.disabled = false;
                } else {
                    elements.loginBtn.classList.remove('hidden');
                    elements.userInfo.classList.add('hidden');
                    elements.generateBtn.disabled = true;
                }
            }
            
            // Reset login button state
            function resetLoginButton() {
                elements.loginBtn.disabled = false;
                elements.loginBtn.textContent = 'Connect';
            }
            
            // Handle authentication
            async function handleLogin() {
                try {
                    elements.loginBtn.disabled = true;
                    elements.loginBtn.textContent = 'Connecting...';
                    
                    console.log('Attempting to sign in...');
                    
                    // Use Puter.js authentication - this will handle popup automatically
                    const result = await puter.auth.signIn();
                    
                    console.log('Sign in result:', result);
                    
                    // Get user info after successful sign in
                    const userInfo = await puter.auth.getUser();
                    
                    console.log('User info:', userInfo);
                    
                    appState.isAuthenticated = true;
                    appState.currentUser = userInfo;
                    
                    updateAuthUI();
                    showToast('Connected successfully!', 'success');
                    
                } catch (error) {
                    console.error('Login failed:', error);
                    appState.isAuthenticated = false;
                    appState.currentUser = null;
                    resetLoginButton();
                    showToast('Connection failed: ' + (error.message || 'Unknown error'), 'error');
                }
            }
            
            // Handle logout  
            async function handleLogout() {
                try {
                    await puter.auth.signOut();
                    appState.isAuthenticated = false;
                    appState.currentUser = null;
                    updateAuthUI();
                    resetLoginButton();
                    showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force logout even if API call fails
                    appState.isAuthenticated = false;
                    appState.currentUser = null;
                    updateAuthUI();
                    resetLoginButton();
                    showToast('Logged out', 'success');
                }
            }
            
            // Set loading state for generate button
            function setGeneratingState(isGenerating) {
                appState.isGenerating = isGenerating;
                
                if (isGenerating) {
                    elements.generateBtn.disabled = true;
                    elements.btnText.classList.add('hidden');
                    elements.btnLoader.classList.remove('hidden');
                } else {
                    elements.generateBtn.disabled = !appState.isAuthenticated;
                    elements.btnText.classList.remove('hidden');
                    elements.btnLoader.classList.add('hidden');
                }
            }
            
            // Create prompt for AI
            function createPrompt() {
                appState.generationCount++;
                
                const topics = [
                    'career failures and professional incompetence',
                    'social awkwardness and relationship disasters',
                    'poor life decisions and lack of common sense',
                    'personal hygiene and appearance issues',
                    'communication skills and intelligence gaps',
                    'lifestyle choices and personal habits',
                    'emotional immaturity and social awareness',
                    'basic life skills and adult responsibilities'
                ];
                
                const currentTopic = topics[appState.generationCount % topics.length];
                const sessionId = Date.now();
                
                return `Create 5 harsh but creative roasts about ${currentTopic}. 
                
Generation #${appState.generationCount} - Session ${sessionId}

Requirements:
- Each roast should be 15-25 words
- Be cutting and memorable
- Focus on the topic: ${currentTopic}
- Make them fresh and unique
- No violence or threats

Return ONLY a JSON object in this exact format:
{
  "roasts": [
    "roast 1 text here",
    "roast 2 text here", 
    "roast 3 text here",
    "roast 4 text here",
    "roast 5 text here"
  ]
}`;
            }
            
            // Parse AI response and extract roasts
            function parseAIResponse(response) {
                console.log('Raw AI response:', response);
                
                let content = '';
                
                // Handle different response formats
                if (typeof response === 'string') {
                    content = response;
                } else if (response && typeof response === 'object') {
                    // Try different possible structures
                    if (response.message && response.message.content) {
                        content = response.message.content;
                    } else if (response.content) {
                        content = response.content;
                    } else if (response.text) {
                        content = response.text;
                    } else {
                        content = JSON.stringify(response);
                    }
                }
                
                console.log('Extracted content:', content);
                
                // Try to extract JSON from content
                try {
                    // Look for JSON in the content
                    let jsonStr = content;
                    
                    // Remove markdown code blocks if present
                    if (content.includes('```
                        const start = content.indexOf('```json') + 7;
                        const end = content.lastIndexOf('```
                        if (start > 6 && end > start) {
                            jsonStr = content.substring(start, end).trim();
                        }
                    } else if (content.includes('```')) {
                        const start = content.indexOf('```
                        const end = content.lastIndexOf('```');
                        if (start > 2 && end > start) {
                            jsonStr = content.substring(start, end).trim();
                        }
                    }
                    
                    // Try to find JSON object in the string
                    const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        jsonStr = jsonMatch[0];
                    }
                    
                    console.log('Cleaned JSON string:', jsonStr);
                    
                    const parsed = JSON.parse(jsonStr);
                    
                    if (parsed.roasts && Array.isArray(parsed.roasts) && parsed.roasts.length > 0) {
                        return parsed.roasts.slice(0, 5); // Ensure max 5 roasts
                    }
                    
                    throw new Error('No roasts found in response');
                    
                } catch (parseError) {
                    console.error('Failed to parse AI response:', parseError);
                    throw new Error('Could not parse AI response');
                }
            }
            
            // Get fallback roasts if AI fails
            function getFallbackRoasts() {
                const fallbackSets = [
                    [
                        "Your career peaked the day you learned to use a calculator.",
                        "You're the reason job applications ask about basic computer skills.",
                        "Your LinkedIn profile is more fiction than your favorite novel.",
                        "You treat deadlines like suggestions and wonder why nobody takes you seriously.",
                        "Your work ethic is so poor it makes minimum wage feel overpaid."
                    ],
                    [
                        "You have the social awareness of a brick wall at a dinner party.",
                        "Your conversation skills make small talk feel like interrogation.",
                        "You're the person everyone avoids at networking events.",
                        "Your dating profile probably lists 'existing' as your main hobby.",
                        "You make awkward silences feel like blessed relief."
                    ],
                    [
                        "Your decision-making process involves a magic 8-ball and immediate regret.",
                        "You consistently choose the worst possible option in any scenario.",
                        "Your life choices read like a manual on what not to do.",
                        "You have the judgment skills of a goldfish with amnesia.",
                        "Your thought process is a masterclass in missing the point entirely."
                    ]
                ];
                
                return fallbackSets[appState.generationCount % fallbackSets.length];
            }
            
            // Generate roasts using AI
            async function generateRoasts() {
                if (!appState.isAuthenticated) {
                    showToast('Please connect first', 'error');
                    return;
                }
                
                if (appState.isGenerating) {
                    return; // Prevent double clicks
                }
                
                setGeneratingState(true);
                
                try {
                    console.log('Starting AI generation...');
                    
                    const prompt = createPrompt();
                    console.log('Using prompt:', prompt);
                    
                    // Call Puter AI with GPT-4o-mini
                    const response = await puter.ai.chat(prompt, {
                        model: 'gpt-4o-mini'
                    });
                    
                    console.log('AI response received:', response);
                    
                    const roasts = parseAIResponse(response);
                    
                    displayRoasts(roasts);
                    showToast(`Generated ${roasts.length} fresh roasts!`, 'success');
                    
                } catch (error) {
                    console.error('AI generation failed:', error);
                    
                    // Use fallback roasts
                    const fallbackRoasts = getFallbackRoasts();
                    displayRoasts(fallbackRoasts);
                    showToast('AI unavailable, using offline roasts', 'error');
                    
                } finally {
                    setGeneratingState(false);
                }
            }
            
            // Display roasts in the UI
            function displayRoasts(roasts) {
                if (!Array.isArray(roasts) || roasts.length === 0) {
                    console.error('Invalid roasts array:', roasts);
                    return;
                }
                
                // Clear previous results
                elements.resultsGrid.innerHTML = '';
                
                // Create roast cards
                roasts.forEach((roast, index) => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.style.animationDelay = (index * 100) + 'ms';
                    
                    card.innerHTML = `
                        <div class="roast-number">Roast #${index + 1}</div>
                        <div class="roast-text">${roast}</div>
                        <button class="copy-btn" data-roast="${roast}">Copy Roast</button>
                    `;
                    
                    elements.resultsGrid.appendChild(card);
                });
                
                // Show results container
                elements.resultsContainer.classList.remove('hidden');
                
                // Scroll to results after a short delay
                setTimeout(() => {
                    elements.resultsContainer.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
            }
            
            // Copy roast to clipboard
            async function copyRoast(text, button) {
                try {
                    await navigator.clipboard.writeText(text);
                    
                    // Update button state
                    const originalText = button.textContent;
                    button.textContent = 'âœ“ Copied!';
                    button.classList.add('copied');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copied');
                    }, 2000);
                    
                    showToast('Copied to clipboard!', 'success');
                    
                } catch (error) {
                    console.error('Copy failed:', error);
                    
                    // Fallback for older browsers
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        showToast('Copied to clipboard!', 'success');
                    } catch (fallbackError) {
                        showToast('Copy failed', 'error');
                    }
                }
            }
            
            // Event listeners
            function attachEventListeners() {
                // Login button
                elements.loginBtn.addEventListener('click', handleLogin);
                
                // Logout button  
                elements.logoutBtn.addEventListener('click', handleLogout);
                
                // Generate button
                elements.generateBtn.addEventListener('click', generateRoasts);
                
                // Copy buttons (using event delegation)
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('copy-btn')) {
                        const roastText = e.target.getAttribute('data-roast');
                        if (roastText) {
                            copyRoast(roastText, e.target);
                        }
                    }
                });
            }
            
            // Check initial authentication state
            async function checkInitialAuth() {
                try {
                    // Check if user is already signed in
                    if (puter.auth.isSignedIn()) {
                        const userInfo = await puter.auth.getUser();
                        appState.isAuthenticated = true;
                        appState.currentUser = userInfo;
                        updateAuthUI();
                        console.log('User already authenticated:', userInfo);
                    }
                } catch (error) {
                    console.log('No existing authentication:', error);
                    appState.isAuthenticated = false;
                    appState.currentUser = null;
                    updateAuthUI();
                }
            }
            
            // Initialize the application
            async function init() {
                console.log('Initializing Master Baiter app...');
                
                // Initialize DOM elements
                initElements();
                
                // Attach event listeners  
                attachEventListeners();
                
                // Check authentication state
                await checkInitialAuth();
                
                console.log('App initialized successfully');
            }
            
            // Start the app when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>
