<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Baiter</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #64748b;
            --accent: #f59e0b;
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 14px;
            position: relative;
        }

        .auth-section {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .login-btn, .logout-btn {
            padding: 12px 20px;
            border: 1px solid var(--primary);
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            background: var(--primary);
            color: white;
            margin: 0;
        }

        .login-btn:focus, .logout-btn:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .login-btn.hidden {
            display: none !important;
        }

        .login-btn:hover, .logout-btn:hover {
            opacity: 0.9;
        }

        .logout-btn {
            background: var(--danger);
            border-color: var(--danger);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 60px 20px 40px;
        }

        .hero-section {
            text-align: center;
            padding: 80px 0 60px;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: -2px;
        }

        .generate-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 50px;
            text-align: center;
        }

        .generate-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
        }

        .generate-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .generate-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(220, 38, 38, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loader {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 50px;
        }

        .results-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 40px;
            color: var(--primary);
            text-transform: uppercase;
        }

        .results-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .roast-number {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .roast-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--text);
            background: var(--bg);
            padding: 24px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-weight: 600;
        }

        .copy-btn {
            width: 100%;
            padding: 14px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            text-transform: uppercase;
        }

        .copy-btn:hover {
            background: #475569;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card-bg);
            color: var(--text);
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: all 0.3s ease;
            font-weight: 500;
            opacity: 0;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .toast.error {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 40px 16px 20px;
            }
            
            .hero-title {
                font-size: 2.8rem;
            }
            
            .generate-section {
                padding: 30px 20px;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="auth-section">
        <button id="loginBtn" class="login-btn">Connect</button>
        <div id="userInfo" class="user-info hidden">
            <div class="status-dot"></div>
            <span id="userName"></span>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
    </div>

    <div class="container">
        <section class="hero-section">
            <h1 class="hero-title">Ragebait 'em</h1>
        </section>

        <section class="generate-section">
            <h2 class="generate-title">Ragebait 'em</h2>
            <p class="generate-subtitle">Imagine being so unemployed you gotta use ts ðŸ¥€</p>
            
            <button id="generateBtn" class="generate-btn" disabled>
                <span class="btn-text">bait 'em all</span>
                <div class="btn-loader hidden"></div>
            </button>
        </section>

        <section class="results-section">
            <div id="resultsContainer" class="results-container hidden">
                <h2 class="results-title">Here you go gng</h2>
                <div class="results-grid" id="resultsGrid"></div>
            </div>
        </section>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        var App = {
            state: {
                loggedIn: false,
                user: null,
                loading: false,
                count: 0
            },
            
            el: {},
            
            start: function() {
                this.getElements();
                this.bindEvents();
                this.checkAuth();
            },
            
            getElements: function() {
                this.el.loginBtn = document.getElementById('loginBtn');
                this.el.logoutBtn = document.getElementById('logoutBtn');
                this.el.userInfo = document.getElementById('userInfo');
                this.el.userName = document.getElementById('userName');
                this.el.generateBtn = document.getElementById('generateBtn');
                this.el.btnText = document.querySelector('.btn-text');
                this.el.btnLoader = document.querySelector('.btn-loader');
                this.el.resultsContainer = document.getElementById('resultsContainer');
                this.el.resultsGrid = document.getElementById('resultsGrid');
                this.el.toast = document.getElementById('toast');
            },
            
            bindEvents: function() {
                var self = this;
                
                this.el.loginBtn.onclick = function() {
                    self.login();
                };
                
                this.el.logoutBtn.onclick = function() {
                    self.logout();
                };
                
                this.el.generateBtn.onclick = function() {
                    self.generate();
                };
                
                document.onclick = function(e) {
                    if (e.target.classList.contains('copy-btn')) {
                        var text = e.target.getAttribute('data-text');
                        self.copyText(text, e.target);
                    }
                };
            },
            
            // âœ… FIXED: Always start logged out - no infinite waiting
            checkAuth: function() {
                this.state.loggedIn = false;
                this.state.user = null;
                this.updateUI();
                console.log('Starting logged out - user must manually connect');
            },
            
            login: function() {
                var self = this;
                this.el.loginBtn.disabled = true;
                this.el.loginBtn.textContent = 'Connecting...';
                
                try {
                    puter.auth.signIn().then(function(result) {
                        return puter.auth.getUser();
                    }).then(function(user) {
                        self.state.loggedIn = true;
                        self.state.user = user;
                        self.updateUI();
                        self.notify('Connected successfully!', 'success');
                    }).catch(function(error) {
                        console.error('Login failed:', error);
                        self.resetLogin();
                        self.notify('Connection failed', 'error');
                    });
                } catch (e) {
                    console.error('Login error:', e);
                    this.resetLogin();
                    this.notify('Login error', 'error');
                }
            },
            
            // âœ… FIXED: Check if signOut exists before calling
            logout: function() {
                var self = this;
                
                if (puter.auth && puter.auth.signOut) {
                    try {
                        puter.auth.signOut().then(function() {
                            self.state.loggedIn = false;
                            self.state.user = null;
                            self.updateUI();
                            self.notify('Logged out', 'success');
                        }).catch(function(error) {
                            console.error('Logout error:', error);
                            // Force logout even if API fails
                            self.state.loggedIn = false;
                            self.state.user = null;
                            self.updateUI();
                            self.notify('Logged out', 'success');
                        });
                    } catch (e) {
                        console.error('Logout exception:', e);
                        this.forceLogout();
                    }
                } else {
                    console.log('signOut not available, forcing logout');
                    this.forceLogout();
                }
            },
            
            forceLogout: function() {
                this.state.loggedIn = false;
                this.state.user = null;
                this.updateUI();
                this.notify('Logged out', 'success');
            },
            
            // âœ… FIXED: Always reset login button properly
            resetLogin: function() {
                this.el.loginBtn.disabled = false;
                this.el.loginBtn.textContent = 'Connect';
            },
            
            updateUI: function() {
                if (this.state.loggedIn && this.state.user) {
                    this.el.loginBtn.classList.add('hidden');
                    this.el.userInfo.classList.remove('hidden');
                    this.el.userName.textContent = this.state.user.username || 'User';
                    this.el.generateBtn.disabled = false;
                } else {
                    this.el.loginBtn.classList.remove('hidden');
                    this.el.userInfo.classList.add('hidden');
                    this.el.generateBtn.disabled = true;
                    this.resetLogin();
                }
            },
            
            generate: function() {
                if (!this.state.loggedIn || this.state.loading) {
                    this.notify('Please connect first', 'error');
                    return;
                }
                
                var self = this;
                this.setLoading(true);
                this.state.count++;
                
                var prompt = this.buildPrompt();
                console.log('Generating with prompt:', prompt);
                
                try {
                    puter.ai.chat(prompt, {model: 'gpt-4o-mini'}).then(function(response) {
                        console.log('AI Response:', response);
                        var roasts = self.extractRoasts(response);
                        self.showRoasts(roasts);
                        self.notify('Generated ' + roasts.length + ' fresh roasts!', 'success');
                    }).catch(function(error) {
                        console.error('AI generation failed:', error);
                        var backup = self.getBackup();
                        self.showRoasts(backup);
                        self.notify('AI failed, using offline roasts', 'error');
                    }).finally(function() {
                        self.setLoading(false);
                    });
                } catch (e) {
                    console.error('Generation exception:', e);
                    this.setLoading(false);
                    var backup = this.getBackup();
                    this.showRoasts(backup);
                    this.notify('Using offline roasts', 'error');
                }
            },
            
            // âœ… IMPROVED: Better variety in prompts
            buildPrompt: function() {
                var topics = [
                    'career failures and professional incompetence',
                    'social awkwardness and poor communication',
                    'terrible life decisions and poor judgment',
                    'personal habits and lifestyle choices',
                    'basic life skills and common sense gaps',
                    'relationship disasters and dating failures'
                ];
                
                var styles = [
                    'cutting and brutal',
                    'condescending and superior',
                    'mockingly sympathetic',
                    'coldly analytical',
                    'dismissively harsh'
                ];
                
                var topic = topics[this.state.count % topics.length];
                var style = styles[Math.floor(this.state.count / 2) % styles.length];
                
                return 'Create exactly 5 harsh roasts about ' + topic + '. Make them ' + style + '. Each should be 15-25 words. Return ONLY this JSON format: {"roasts": ["roast1", "roast2", "roast3", "roast4", "roast5"]}';
            },
            
            extractRoasts: function(response) {
                var content = '';
                
                if (typeof response === 'string') {
                    content = response;
                } else if (response && response.message && response.message.content) {
                    content = response.message.content;
                } else if (response && response.content) {
                    content = response.content;
                } else {
                    content = JSON.stringify(response);
                }
                
                console.log('Extracting from content:', content);
                
                try {
                    // Find JSON in the response
                    var start = content.indexOf('{');
                    var end = content.lastIndexOf('}') + 1;
                    
                    if (start >= 0 && end > start) {
                        var jsonStr = content.substring(start, end);
                        console.log('Trying to parse:', jsonStr);
                        
                        var data = JSON.parse(jsonStr);
                        
                        if (data.roasts && Array.isArray(data.roasts) && data.roasts.length > 0) {
                            return data.roasts.slice(0, 5);
                        }
                    }
                } catch (e) {
                    console.error('JSON parse failed:', e);
                }
                
                console.log('Using backup roasts');
                return this.getBackup();
            },
            
            getBackup: function() {
                var sets = [
                    [
                        "Your resume is so thin it makes tissue paper look substantial.",
                        "You make participation trophies feel like they're overachieving.",
                        "Your career peaked when you learned to spell your own name correctly.",
                        "You treat job interviews like casual coffee chats and wonder why nobody calls back.",
                        "Your work ethic makes sloths look like overachievers with something to prove."
                    ],
                    [
                        "Your social skills come with their own built-in warning label for bystanders.",
                        "You make small talk feel like a hostile interrogation at a police station.",
                        "Your conversation starters have killed more conversations than awkward silences ever could.",
                        "You possess all the natural charm and appeal of a parking ticket on Christmas morning.",
                        "Your presence at networking events clears rooms faster than fire alarms during lunch breaks."
                    ],
                    [
                        "Your decision-making process makes coin flips look like strategic masterpieces of human intelligence.",
                        "You consistently choose chaos and confusion when presented with simple, straightforward options and solutions.",
                        "Your judgment calls require immediate professional intervention from qualified mental health specialists and life coaches.",
                        "You transform bad choices into elaborate art forms that defy logic, reason, and basic common sense.",
                        "Your thought processes consistently challenge everything we know about human intelligence and rational thinking patterns."
                    ],
                    [
                        "Your personal hygiene routine appears to be more of a theoretical concept than practical reality.",
                        "You dress like fashion magazines are written in a foreign language you've never bothered learning.",
                        "Your lifestyle choices read like a comprehensive guide on what not to do with your life.",
                        "Your daily habits make questionable life decisions look like carefully planned strategic moves.",
                        "You treat basic adult responsibilities like optional suggestions from people who don't understand your artistic vision."
                    ],
                    [
                        "Your communication skills make mime artists look incredibly chatty and socially engaging by comparison.",
                        "You possess the intellectual depth and complexity of a puddle during a severe drought.",
                        "Your contributions to conversations are about as valuable as expired coupons at luxury stores.",
                        "You make basic comprehension look like advanced rocket science that requires multiple graduate degrees.",
                        "Your understanding of social cues rivals that of a brick wall at a diplomatic dinner party."
                    ]
                ];
                
                return sets[this.state.count % sets.length];
            },
            
            showRoasts: function(roasts) {
                this.el.resultsGrid.innerHTML = '';
                
                for (var i = 0; i < roasts.length; i++) {
                    var card = document.createElement('div');
                    card.className = 'result-card';
                    
                    card.innerHTML = '<div class="roast-number">Roast #' + (i + 1) + '</div>' +
                                   '<div class="roast-text">' + roasts[i] + '</div>' +
                                   '<button class="copy-btn" data-text="' + roasts[i] + '">Copy Roast</button>';
                    
                    this.el.resultsGrid.appendChild(card);
                }
                
                this.el.resultsContainer.classList.remove('hidden');
                
                var self = this;
                setTimeout(function() {
                    self.el.resultsContainer.scrollIntoView({behavior: 'smooth'});
                }, 200);
            },
            
            copyText: function(text, button) {
                var self = this;
                
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).then(function() {
                            self.showCopied(button);
                            self.notify('Copied to clipboard!', 'success');
                        }).catch(function() {
                            self.fallbackCopy(text, button);
                        });
                    } else {
                        this.fallbackCopy(text, button);
                    }
                } catch (e) {
                    this.fallbackCopy(text, button);
                }
            },
            
            fallbackCopy: function(text, button) {
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                this.showCopied(button);
                this.notify('Copied to clipboard!', 'success');
            },
            
            showCopied: function(button) {
                var original = button.textContent;
                button.textContent = 'âœ“ Copied!';
                button.classList.add('copied');
                
                setTimeout(function() {
                    button.textContent = original;
                    button.classList.remove('copied');
                }, 1500);
            },
            
            setLoading: function(loading) {
                this.state.loading = loading;
                
                if (loading) {
                    this.el.generateBtn.disabled = true;
                    this.el.btnText.classList.add('hidden');
                    this.el.btnLoader.classList.remove('hidden');
                } else {
                    this.el.generateBtn.disabled = !this.state.loggedIn;
                    this.el.btnText.classList.remove('hidden');
                    this.el.btnLoader.classList.add('hidden');
                }
            },
            
            notify: function(message, type) {
                var self = this;
                
                // Clear any existing toast
                this.el.toast.className = 'toast';
                this.el.toast.style.opacity = '0';
                
                setTimeout(function() {
                    self.el.toast.textContent = message;
                    self.el.toast.classList.add(type || 'info');
                    
                    setTimeout(function() {
                        self.el.toast.classList.add('show');
                        self.el.toast.style.opacity = '1';
                    }, 50);
                    
                    setTimeout(function() {
                        self.el.toast.classList.remove('show');
                        self.el.toast.style.opacity = '0';
                    }, 3500);
                }, 100);
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            App.start();
        });
    </script>
</body>
</html>
